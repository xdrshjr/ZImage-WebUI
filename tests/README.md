# API接口测试说明

## 概述

`test_api.py` 是一个完整的API接口测试工具，用于测试Z-Image-Turbo Flask服务的所有接口功能。

## 功能特性

- ✅ 测试所有API接口（健康检查、提交任务、查询状态、获取结果、系统状态）
- ✅ 支持指定IP和端口
- ✅ 自动等待任务完成并下载生成的图像
- ✅ 参数验证测试
- ✅ 详细的测试报告和结果输出
- ✅ 支持跳过图像生成测试（快速测试）

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 基本用法

测试本地服务（默认 localhost:5000）：

```bash
python tests/test_api.py
```

### 指定IP和端口

```bash
# 测试指定IP和端口
python tests/test_api.py --host 192.168.1.100 --port 8080
```

### 跳过图像生成测试

如果只想快速测试接口是否正常，不等待图像生成：

```bash
python tests/test_api.py --skip-image-generation
```

### 不等待任务完成

只测试接口调用，不等待任务完成和下载图像：

```bash
python tests/test_api.py --no-wait
```

### 组合使用

```bash
# 测试远程服务，跳过图像生成
python tests/test_api.py --host 192.168.1.100 --port 5000 --skip-image-generation
```

## 测试内容

测试工具会依次测试以下接口：

1. **健康检查** (`GET /health`)
   - 检查服务是否正常运行
   - 检查模型是否已加载

2. **查询系统状态** (`GET /api/status`)
   - 检查队列状态
   - 检查GPU使用情况
   - 检查模型加载状态

3. **参数验证**
   - 测试缺少必填参数的情况
   - 测试无效参数的情况
   - 测试不存在的资源

4. **提交生成任务** (`POST /api/generate`)
   - 提交一个图像生成任务
   - 验证返回的任务ID和状态

5. **查询任务状态** (`GET /api/task/<task_id>`)
   - 查询任务详细信息
   - 验证任务状态更新

6. **获取任务结果** (`GET /api/result/<task_id>`)
   - 等待任务完成（如果启用）
   - 下载生成的图像文件
   - 保存到 `tests/output/` 目录

## 输出说明

测试运行时会显示：

- ✅ PASS - 测试通过
- ❌ FAIL - 测试失败

每个测试都会显示详细信息，包括：
- 任务ID
- 任务状态
- 队列位置
- GPU使用情况
- 错误信息（如果有）

测试结束后会显示总结：
- 总测试数
- 通过的测试数
- 失败的测试数
- 失败测试的详细信息

## 输出文件

生成的测试图像会保存在 `tests/output/` 目录下，文件名格式为：
```
test_result_<task_id>.png
```

## 注意事项

1. **服务必须已启动**: 运行测试前，确保Flask服务已启动并可以访问
2. **图像生成需要时间**: 如果启用图像生成测试，可能需要等待几分钟
3. **GPU资源**: 确保有足够的GPU显存来运行模型
4. **网络连接**: 如果测试远程服务，确保网络连接正常

## 示例输出

```
============================================================
开始API接口测试
测试目标: http://localhost:5000
============================================================

【1/6】测试健康检查接口...
✅ PASS - 健康检查
    服务状态: healthy, 模型已加载: True

【2/6】测试查询系统状态接口...
✅ PASS - 查询系统状态
    队列长度: 0, 模型已加载: True, GPU可用: True, GPU使用率: 45.23%

【3/6】测试参数验证...
✅ PASS - 参数验证 - 缺少prompt
    正确返回400错误
✅ PASS - 参数验证 - 无效height
    正确返回400错误
✅ PASS - 参数验证 - 不存在任务
    正确返回404错误

【4/6】测试提交生成任务接口...
✅ PASS - 提交生成任务
    任务ID: 550e8400-e29b-41d4-a716-446655440000, 状态: pending, 队列位置: 1

【5/6】测试查询任务状态接口...
✅ PASS - 查询任务状态
    任务状态: processing, 提示词: A beautiful sunset over the ocean, high quality...

【6/6】测试获取任务结果接口...
    等待任务完成 (最多等待 300 秒)...
    当前状态: processing, 等待中...
    任务已完成，耗时: 25 秒
✅ PASS - 获取任务结果
    图像已保存: tests/output/test_result_550e8400-e29b-41d4-a716-446655440000.png, 大小: 2048.50 KB

============================================================
测试总结
============================================================
总测试数: 6
通过: 6 ✅
失败: 0 ❌

============================================================
```

## 故障排查

### 连接失败

如果出现连接错误，检查：
- 服务是否已启动
- IP和端口是否正确
- 防火墙设置

### 任务超时

如果任务长时间未完成：
- 检查GPU是否正常工作
- 检查模型是否正确加载
- 增加等待时间（修改代码中的 `max_wait_time` 参数）

### 图像下载失败

如果图像下载失败：
- 检查任务是否真的已完成
- 检查输出目录权限
- 检查磁盘空间

## 扩展测试

如果需要添加更多测试用例，可以修改 `test_api.py` 文件，添加新的测试方法。



